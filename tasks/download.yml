---
# Role download tasks

- block:
    - block:
        - name: download maven wagon required by oracle repository
          get_url:
            url: "{{ oracle_jdbc_connector_maven.wagon_url }}"
            dest: "{{ oracle_jdbc_connector_maven.ext_path }}"
          register: oracle_jdbc_connector_wagon_download_result

        - name: generate maven master encrypted password
          shell: >-
            mvn --encrypt-master-password {{ oracle_jdbc_connector_password }}
          changed_when: false
          register: oracle_jdbc_connector_maven_master_key_result

        - name: setup maven security settings file
          template:
            src: security-settings.xml.j2
            dest: >-
              {{ oracle_jdbc_connector_download_dest }}/security-settings.xml
            mode: 0600

        - name: encrypt oracle maven repository password
          shell: >-
            mvn
            -Dsettings.security={{ oracle_jdbc_connector_download_dest
                                   + "/security-settings.xml "
                                   + "--encrypt-password "
                                   + oracle_jdbc_connector_password }}
          changed_when: false
          register: oracle_jdbc_connector_maven_repo_key_result

        - name: setup maven settings file
          template:
            src: settings.xml.j2
            dest: "{{ oracle_jdbc_connector_download_dest }}/settings.xml"

        - name: setup maven project file
          template:
            src: pom.xml.j2
            dest: "{{ oracle_jdbc_connector_download_dest }}/pom.xml"

        - name: download oracle jdbc connector from maven repository
          shell: >-
            mvn
            -Dsettings.security={{ oracle_jdbc_connector_download_dest
                                   + "/security-settings.xml "
                                   + "-s "
                                   + oracle_jdbc_connector_download_dest
                                   + "/settings.xml compile" }}
          args:
            chdir: "{{ oracle_jdbc_connector_download_dest }}"
          register: oracle_jdbc_connector_maven_compile_result
      when:
        - oracle_jdbc_connector_artifact is undefined
        - not oracle_jdbc_connector_jar_check_result.stat.exists

    - name: download mysql jdbc connector artifact
      include_role:
        name: amtega.artifact
      vars:
        override:
          dest: "{{ oracle_jdbc_connector_download_dest }}"
          download: >-
            {{ not oracle_jdbc_connector_jar_check_result.stat.exists }}
        artifact: >-
          {{ oracle_jdbc_connector_artifact | combine(override) }}
        artifact_http_proxy: "{{ oracle_jdbc_connector_http_proxy }}"
        artifact_https_proxy: "{{ oracle_jdbc_connector_https_proxy }}"
        artifact_no_proxy: "{{ oracle_jdbc_connector_no_proxy }}"
      when: oracle_jdbc_connector_artifact is defined
  when: oracle_jdbc_connector_state == "present"
  environment: "{{ oracle_jdbc_connector_http_proxy_environment }}"
  tags:
    - role::oracle_jdbc_connector
    - role::oracle_jdbc_connector::download
