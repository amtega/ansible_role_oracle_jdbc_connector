---
# Tasks for testing role

- name: Configure sandbox environment
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      vars:
        docker_presets_images_json_query: >-
          [? starts_with(name, `centos-7`)
             || starts_with(name, `fedora-29`)
             || starts_with(name, `fedora-30`) ]
  tags:
    - sandbox

- name: Setup docker sandbox for testing
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      vars:
        docker_sandbox_state: started
        docker_sandbox_idempotence_test: no
  tags:
    - sandbox

- name: Prepare docker sandbox for testing
  hosts: docker_sandbox_containers
  tasks:
    - name: Create folder for fake jar files
      file:
        path: /tmp/jdbc
        state: directory

    - name: Create fake jar file for custom url download test
      copy:
        dest: "/tmp/jdbc/{{ item }}.jar"
        content: "Fake file"
        force: yes
      loop:
        - ojdbc8
        - ucp
        - oraclepki
        - osdt_cert
        - osdt_core
        - orai18n
        - xdb6
        - ons
        - simplefan

    - name: Create tarball with fake jar files
      archive:
        path: /tmp/jdbc
        dest: /tmp/jdbc.tar.gz
  tags:
    - sandbox

- name: Test oracle_jdbc_connector role with maven download
  hosts: docker_sandbox_containers
  roles:
    - amtega.oracle_jdbc_connector
  vars:
      oracle_jdbc_connector_state: present
      oracle_jdbc_connector_version: 12.2.0.1
      oracle_jdbc_connector_components:
        - ojdbc8
        - ucp
        - oraclepki
        - osdt_cert
        - osdt_core
        - orai18n
        - xdb6
        - ons
        - simplefan
      oracle_jdbc_connector_dir: /root
      oracle_jdbc_connector_download_dest: /root
  tasks:
    - name: Check oracle connector component
      stat:
        path: "{{ oracle_jdbc_connector_dir}}/{{ item }}.jar"
      loop: "{{ oracle_jdbc_connector_components }}"
      register: check_install_result

    - name: Check that oracle jdbc connector component was installed
      assert:
        that:
          - >-
            check_install_result.results
            | selectattr("stat.exists", "equalto", "false")
            | list
            | length == 0

    - name: Remove deployed jar to prepare next test
      file:
        path: "{{ oracle_jdbc_connector_dir}}/{{ item }}.jar"
        state: absent
      loop: "{{ oracle_jdbc_connector_components }}"
  tags:
    - maven

- name: Test oracle_jdbc_connector role with custom artifact
  hosts: docker_sandbox_containers
  roles:
    - amtega.oracle_jdbc_connector
  vars:
      oracle_jdbc_connector_state: present
      oracle_jdbc_connector_version: 12.2.0.1
      oracle_jdbc_connector_dir: /root
      oracle_jdbc_connector_download_dest: /root
      oracle_jdbc_connector_artifact:
        id: oracle_jdbc_connector
        type: http
        host: "file:"
        path: /tmp
        file: jdbc.tar.gz
      oracle_jdbc_connector_remove_artifact: no
  tasks:
    - name: Check oracle connector component
      stat:
        path: "{{ oracle_jdbc_connector_dir}}/{{ item }}.jar"
      loop: "{{ oracle_jdbc_connector_components }}"
      register: check_install_result

    - name: Check that oracle jdbc connector component was installed
      assert:
        that:
          - >-
            check_install_result.results
            | selectattr("stat.exists", "equalto", "false")
            | list
            | length == 0
  tags:
    - artifact

- name: Test oracle_jdbc_connector role absent state
  hosts: docker_sandbox_containers
  roles:
    - amtega.oracle_jdbc_connector
  vars:
      oracle_jdbc_connector_state: absent
      oracle_jdbc_connector_version: 12.2.0.1
      oracle_jdbc_connector_components:
        - ojdbc8
        - ucp
        - oraclepki
        - osdt_cert
        - osdt_core
        - orai18n
        - xdb6
        - ons
        - simplefan
      oracle_jdbc_connector_dir: /root
  tasks:
    - name: Check oracle connector component
      stat:
        path: "{{ oracle_jdbc_connector_dir}}/{{ item }}.jar"
      loop: "{{ oracle_jdbc_connector_components }}"
      register: check_install_result

    - name: Check that oracle jdbc connector was uninstalled
      assert:
        that:
          - >-
            check_install_result.results
            | selectattr("stat.exists", "equalto", "true")
            | list
            | length == 0

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      vars:
        docker_sandbox_state: absent
  tags:
    - sandbox
